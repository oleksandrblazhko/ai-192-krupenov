# 4.2.2 - Налаштування платформи тестового застосунку

## Підсумки

Правильна конфігурація окремих елементів, що складають архітектуру застосунку, важлива для запобігання помилок, які можуть поставити під загрозу безпеку всієї архітектури.

Перевірка та тестування конфігурації є критично важливим завданням при створенні та підтримці архітектури. Це пов'язано з тим, що багато різних систем зазвичай надаються з загальними конфігураціями, які можуть не відповідати завданням, які вони будуть виконувати на тому конкретному сайті, де вони встановлені.

Хоча типова інсталяція веб-сервера і сервера застосунків буде містить багато функціональності (наприклад, приклади додатків, документація, тестові сторінки), але те, що не є необхідним, слід видалити перед розгортанням, щоб уникнути експлуатації після встановлення.

- Впевніться, що налаштування за замовчуванням та відомі файли були прибрані.
- Впевніться, що ніякого коду або розширень для відлагодження не лишилося у середовищі для виробництва.
- Перегляньте механізми ведення журналів, що задіяні у застосунку.

# Як Здійснюється Тестування
## Тестування методом "Чорної Коробки" (Black-Box)
### Зразкові та Відомі Файли та Директорії

Багато веб-серверів та серверів додатків при встановленні за замовчуванням надають зразки додатків і файлів для користі я розробника і для того, щоб перевірити правильність роботи сервера відразу після встановлення. Однак, багато стандартних додатків веб-серверів, як згодом виявилося, є вразливими. Так було, наприклад, із CVE-1999-0449 (Відмова в обслуговуванні в IIS коли зразок сайту Exair був встановлений), CAN-2002-1744 (Обхід каталогу в CodeBrws.asp в Microsoft IIS 5.0), CAN-2002-1630 (Використання sendmail.jsp в Oracle 9iAS) або CAN-2003-1172 (Обхід директорії в зразку "представлення-джерело" в Cocoon від Apache).

CGI-сканери містять детальний список відомих файлів і зразків директорій, які надаються різними веб-серверами або серверами додатків, і можуть бути швидким способом визначити, чи присутні ці файли. Однак, єдиний спосіб бути дійсно впевненим - це зробити повний огляд вмісту веб-сервера або сервера додатків та визначити, чи мають вони відношення до самого додатка чи ні.

### Огляд Коментарів

При розробці великих веб-додатків програмісти дуже часто додають коментарі. Однак коментарі, включені вбудованими в HTML-код, можуть розкривати внутрішню інформацію, яка не повинна бути доступною зловмиснику. Іноді навіть вихідний код прибирається у коментарі через те, що певна функція більше не потрібна, але такий коментар потрапляє на HTML-сторінки, які повертаються користувачам, ненавмисно.

Огляд коментарів повинен здійснюватися для того, щоб визначити, чи не відбувається витік інформації через коментарі. Такий огляд можна провести лише шляхом аналізу статичного та динамічного вмісту веб-сервера, а також через пошук у файлах. Може бути корисно переглянути сайт в автоматичному або керованому способі та зберегти весь отриманий вміст. Потім у цьому отриманий вміст можна здійснити пошук, щоб проаналізувати будь-які HTML-коментарі, наявні в коді.

### Налаштування системи

Різні інструменти, документи або контрольні списки можуть бути використані для надання фахівцям з IT та безпеки детальної оцінки відповідності цільових систем різним конфігураційним стандартам або еталонним показникам. Такі інструменти включають (але не обмежуються):

- CIS-CAT Lite
- Attack Surface Analyzer від Microsoft
- National Checklist Program від NIST

## Тестування методом "Сірої Коробки" (Gray-Box)

### Огляд Конфігурації

Конфігурація веб-сервера або сервера додатків відіграє важливу роль у захисті вмісту сайту, і її слід ретельно переглядати, щоб виявити типові помилки конфігурації. Очевидно, що рекомендована конфігурація різниться залежно від політики сайту та функціональності, яка повинна бути забезпечена програмним забезпеченням сервера. Однак у більшості випадків слід дотримуватися рекомендацій щодо конфігурації (наданих постачальником програмного забезпечення або зовнішніми сторонами), щоб визначити, чи належним чином захищений сервер.

Неможливо узагальнено сказати, як слід конфігурувати сервер, однак слід враховувати деякі загальні рекомендації:

- Увімкніть лише ті серверні модулі (розширення ISAPI у випадку IIS), які необхідні для роботи програми. Це зменшує поверхню атаки, оскільки сервер зменшується в розмірі та складності якщо програмні модулі відключаються. Це також запобігає тому, що вразливості, які можуть з'явитися в програмному забезпеченні постачальника, матимуть вплив на сайт, якщо вони присутні лише у вже відключених модулях.
- Обробляйте помилки сервера (40x або 50x) за допомогою спеціально зроблених сторінок, а не сторінок веб-сервера за замовчуванням. Зокрема, переконайтеся, що будь-які помилки застосувння не повертаються кінцевому користувачеві і що ніякий код не вітікає через такі помилки - інакше, це може допомогти зловмиснику. Насправді, дуже часто забувається про цей пункт, оскільки розробники потребують цю інформації в середовищі етапу перед виробництвом.
- Переконайтеся, що серверне програмне забезпечення працює з мінімізованими привілеями в операційній системі. Це запобігає тому, що помилка в серверному програмному забезпеченні прямо підставляє всю систему під загрозу, хоча зловмисник може підвищити привілеї, запустивши код від особи веб-сервера.
- Переконайтеся, що серверне програмне забезпечення належним чином веде журнал і законного доступу, і помилок.
- Переконайтеся, що сервер налаштований так, щоб належним чином справлятися з перевантаженнями і запобігати атакам відмови в обслуговуванні. Переконайтеся, що сервер налаштований у продуктивністі належним чином.
- Ніколи не надавайте неадміністративним обліковим записам (за винятком NT SERVICE\WMSvc) доступ до applicationHost, config, redirection.config і administration.config (доступ ні на читання, ні на запис). Це включає в себе мережеву службу, IIS_IUSRS, IUSR, або будь-який користувацький обліковий запис, що використовується множинами застосунків IIS. Процеси-робітники IIS не повинні мати прямого доступу до цих файлів.
- Ніколи не надавайте спільний доступ до applicationHost.config, redirection.config та administration.config по мережі. Якщо ви використовуєте спільну конфігурацію, краще експортувати applicationHost.config в інше місце (див. розділ "Встановлення дозволів для спільної конфігурації").
- Майте на увазі, всі користувачі можуть читати файли .NET Framework machine.config і root web.config за замовчуванням. Не зберігайте конфіденційну інформацію в цих файлах, якщо вона має бути лише для перегляду адміністратором.
- Шифруйте конфіденційну інформацію, яку повинні читати лише процеси-робітники IIS, а не інші користувачі на машині.
- Не надавайте доступ на запис обліковому запису, який веб-сервер використовує для доступу до спільного applicationHost.config. Цей обліковий запис повинен мати права лише на читання.
- Використовуйте окремий обліковий запис для публікації applicationHost.config у спільний доступ. Не використовуйте цей обліковий запис для налаштування доступу до спільної конфігурації на веб-серверах.
- Використовуйте надійний пароль під час експорту ключів шифрування для використання у спільній конфігурації.
- Підтримуйте обмежений доступ до спільного ресурсу, що містить спільну конфігурацію та ключі шифрування. Якщо цей ресурс буде скомпрометовано, зловмисник зможе читати і записувати будь-яку конфігурацію IIS для ваших веб-серверів, перенаправляти трафік з вашого веб-сайту на шкідливі джерела, а в деяких випадках отримати контроль над усіма веб-серверами шляхом завантаження довільного коду в процеси-робітники IIS.
- Подумайте про захист цього ресурсу за допомогою правил брандмауера і політик IPsec, щоб дозволити підключення лише веб-серверам-учасникам.

### Ведення журналів

Ведення журналів є важливим активом безпеки архітектури додатку, оскільки його можна використовувати для виявлення недоліків у додатках (користувачі постійно намагаються отримати файл, якого насправді не існує), а також для виявлення постійних атак з боку зловмисників. Журнали зазвичай належним чином генеруються веб-програмами та іншим серверним програмним забезпеченням. Нечасто можна зустріти програми, які належним чином записують свої дії до журналу, а коли вони це роблять, то основним призначенням журналів програми є створення виводу для відлагодження, який може бути використаний програмістом для аналізу конкретної помилки.

В обох випадках (журналів сервера та застосунку) слід протестувати та проаналізувати декілька проблем на основі вмісту журналу:

- Чи містять журнали конфіденційну інформацію?
- Чи зберігаються журнали на спеціально виділеному сервері?
- Чи може використання журналів спричинити відмову в обслуговуванні?
- Як проходить їх цикл життя, їх ротація? Чи зберігаються журнали протягом достатньогї кількості часу?
- Як переглядаються журнали? Чи можуть адміністратори використовувати ці переглядання для виявлення цілеспрямованих атак?
- Як зберігаються резервні копії журналів?
- Чи перевіряються дані, що мають записуватися в журнал (на мінімальну, максимальну довжину, символи та ін.) перед тим, як записуються?

### Конфіденційна Інформація в Журналах

Деякі програми можуть, наприклад, використовувати GET-запити для пересилання даних з форм, які будуть відображатися в журналах сервера. Це означає, що журнали сервера можуть містити конфіденційну інформацію (таку, як імена користувачів, паролі або дані банківських рахунків). Ця конфіденційна інформація може бути використана зловмисником, якщо він отримав журнали, наприклад, через адміністративні інтерфейси або відомі вразливості чи неправильну конфігурацію веб-сервера (як, наприклад, широко відома неправильна конфігурація статусу сервера в HTTP-серверах на основі Apache).

Журнали подій часто містять дані, які можуть бути корисними для зловмисника (витік інформації) або можуть бути використані безпосередньо в експлуатаціях:

- Інформація відлагодження
- Відстаження стеку
- Імена користувачів
- Назви компонентів системи
- Внутрішні IP-адреси
- Менш конфіденційні особисті дані (e.g. адреси електронної пошти, адреси доставки поштою та номери телефонів, пов'язані з іменованими особами)
- Дані, що відносяться до роботи/компаній

Крім того, в деяких юрисдикціях зберігання певної конфіденційної інформації у файлах журналів, таких, як персональних даних, може зобов'язати підприємство застосувати закони про захист даних, які вони б застосовували і до своїх внутрішніх баз даних для запису журналів. А невиконання цієї вимоги, навіть несвідоме, може призвести до штрафів згідно з чинним законодавством про захист даних.

Ось ширший перелік конфіденційної інформації:

- Вихідний код програми
- Ідентифікаційні значення сесії
- Жетони доступу
- Конфіденційні особисті дані та деякі форми інформації, що дозволяє ідентифікувати особу (PII)
- Паролі автентифікації
- Рядки підключення до бази даних
- Ключі шифрування
- Дані банківського рахунку або власника платіжної картки
- Дані з більш високим ступенем секретності, ніж дозволено зберігати системі реєстрації
- Інформація, що становить комерційну таємницю
- Інформація, збір якої є незаконним у відповідній юрисдикції
- Інформація, від збирання якої користувач відмовився, або на яку не дав згоду, наприклад, використання функції "не відстежувати", або коли термін дії згоди на збір закінчився

### Розташування журналів

Зазвичай сервери створюють локальні журнали своїх дій та помилок, займаючи диск системи, на якій працює сервер. Однак, якщо сервер скомпрометований, його журнали можуть бути знищені зловмисником, щоб прибрати всі сліди своєї атаки і засобів її здійснення. Якщо це станеться, системний адміністратор не матиме жодних відомостей про те, як відбулася атака або де знаходиться джерело атаки. Насправді, більшість наборів інструментів зловмисників включають в себе "log zapper" - спалювач логів, який здатний очистити будь-які журнали, що містять певну інформацію (наприклад, IP-адресу зловмисника) і зазвичай використовуються в системних руткітах зловмисника.

Отже, розумніше зберігати журнали в окремому місці, а не на самому веб-сервері. Це також полегшує агрегування журналів з різних джерел, які відносяться до однієї програми (наприклад, з ферми веб-серверів), а також полегшує аналіз журналів (який може бути ресурсоємним), не впливаючи на сам сервер.

### Зберігання журналів

Журнали можуть спричинити відмову в обслуговуванні, якщо вони не зберігаються належним чином. Будь-який зловмисник з достатніми ресурсами може створити достатню кількість запитів для заповнення всього місця, відведеного для файлів журналів, якщо для нього не буде спеціальних перешкод. Однак, якщо сервер не налаштований належним чином, файли журналів будуть зберігатися в тому ж розділі диска, що використовується для програмного забезпечення операційної системи або для самого застосунку. Це означає, що якщо диск буде переповнений, операційна система або програма може вийти з ладу через неможливість запису на диск.

Зазвичай в UNIX-системах журнали розташовуються у каталозі /var (хоча деякі серверні встановлення можуть розташовуватися у каталозі /opt або /usr/local), тому важливо переконатися, що каталоги, у яких зберігаються журнали, знаходяться в окремому розділі. У деяких випадках, щоб запобігти впливу на системні журнали, каталог журналів самого серверного програмного забезпечення (наприклад, /var/log/apache у веб-сервері Apache) слід зберігати у виділеному розділі.

Це не означає, що журналам слід дозволяти розростатися, переповнюючи файлову систему, в якій вони зберігаються. Зростання журналів сервера слід відстежувати, щоб виявити цей стан, оскільки це може свідчити про атаку.

Перевірити цю умову так само легко, як і небезпечно у виробничих середовищах, як і виконати достатню і тривалу кількість запитів, щоб побачити, чи записуються ці запити в журнал і чи є можливість заповнити розділ журналу за допомогою цих запитів. У деяких середовищах, де параметри QUERY_STRING також записуються в журнал, незалежно від того, чи були вони отримані за допомогою GET або POST запитів, можна змоделювати великі запити, які заповнять журнали швидше, оскільки, як правило, один запит призводить до запису лише невеликої кількості даних, таких як дата і час, IP-адреса джерела, URI запиту і результат сервера.

### Цикл життя/ротація журналів

Більшість серверів (за виключенням кількох користувацьких застосунків) здійснюють ротацію журнали, щоб запобігти переповненню файлової системи, в якій вони знаходяться. При ротації журналів передбачається, що інформація в них необхідна лише протягом обмеженого періоду часу.

Цю можливість слід протестувати, щоб переконатися у цьому:

- Журнали зберігаються протягом часу, визначеного політикою безпеки, не більше і не менше.
- Журнали стискаються, тільки-но здійснена ротація (це зручно, оскільки це означає, що більше журналів буде зберігатися на тому ж доступному місці на диску).
- Дозволи до файлової системи для файлів журналів, до яких застосована ротація, такі самі (або суворіші), як і для самих файлів журналів. Наприклад, веб-серверам потрібно писати до журналів, які вони використовують, але насправді їм не потрібно писати до журналів у ротації, а це означає, що дозволи файлів можуть бути змінені під час обертання, щоб запобігти зміні цих дозволів процесом веб-сервера.

Деякі сервери можуть здійснювати ротацію журналів, коли вони досягають певного розміру. Якщо це трапляється, необхідно переконатися, що зловмисник не може приховати свої сліди, змусивши журнали здійснити ротацію.

### Контроль над доступом до журналів

Інформація журналу подій ніколи не повинна бути видимою для кінцевих користувачів. Навіть веб-адміністратори не повинні мати змоги бачити такі журнали, оскільки це порушує розподіл обов'язків. Переконайтеся, що будь-яка схема контролю доступу, використана для захисту доступу до необроблених журналів і будь-яких додатків, що надають можливості перегляду або пошуку в журналах, не пов'язана зі схемами контролю доступу для інших ролей користувачів додатків. Дані журналів також не повинні бути доступними для перегляду неавторизованими користувачами.

### Перевірка журналів

Перегляд журналів можна використовувати не лише для вилучення статистики використання файлів на веб-серверах (що зазвичай є основним завданням більшості додатків, що основані на журналах), але й для визначення того, чи відбуваються атаки на веб-сервер.

Для аналізу атак на веб-сервер необхідно проаналізувати файли журналу помилок сервера. Перевірку слід сконцентрувати на:

- повідомленнях про помилки кодів 40x (не знайдено). Велика кількість таких повідомлень від одного джерела може свідчити про те, що проти веб-сервера використовується CGI-сканер
- повідомленнях про помилки кодів 50x (помилка сервера). Це може свідчити про те, що зловмисник використовує вразливості частин програми, які несподівано виходять з ладу. Наприклад, на перших етапах атаки SQL-ін'єкцією ці повідомлення про помилки з'являються, коли SQL-запит неправильно сформульовано, і його виконання не вдається у внутрішній базі даних.

Статистику або аналіз логів не слід ні генерувати, ні зберігати на тому ж сервері, який їх створює. В іншому випадку зловмисник може через вразливість веб-сервера або неправильне налаштування отримати доступ до них і витягти інформацію, подібну до тієї, що міститься в самих файлах журналів.

# Перелік посилань

- Apache
    - Apache Security, by Ivan Ristic, O’reilly, March 2005.
    - [Apache Security Secrets: Revealed (Again), Mark Cox, November 2003](https://awe.com/mark/talks/apachecon2003us.html)
    - [Apache Security Secrets: Revealed, ApacheCon 2002, Las Vegas, Mark J Cox, October 2002](https://awe.com/mark/talks/apachecon2002us.html)
    - [Performance Tuning](https://httpd.apache.org/docs/current/misc/perf-tuning.html)
- Lotus Domino
    - Lotus Security Handbook, William Tworek et al., April 2004, available in the IBM Redbooks collection
    - Lotus Domino Security, an X-force white-paper, Internet Security Systems, December 2002
    - Hackproofing Lotus Domino Web Server, David Litchfield, October 2001
- Microsoft IIS
    - [Security Best Practices for IIS 8](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj635855(v=ws.11))
    - [CIS Microsoft IIS Benchmarks](https://www.cisecurity.org/benchmark/microsoft_iis/)
    - Securing Your Web Server (Patterns and Practices), Microsoft Corporation, January 2004
    - IIS Security and Programming Countermeasures, by Jason Coombs
    - From Blueprint to Fortress: A Guide to Securing IIS 5.0, by John Davis, Microsoft Corporation, June 2001
    - Secure Internet Information Services 5 Checklist, by Michael Howard, Microsoft Corporation, June 2000
- iPlanet від Red Hat (раніше Netscape)
    - Guide to the Secure Configuration and Administration of iPlanet Web Server, Enterprise Edition 4.1, by James M Hayes, The Network Applications Team of the Systems and Network Attack Center (SNAC), NSA, January 2001
- WebSphere
    - IBM WebSphere V5.0 Security, WebSphere Handbook Series, by Peter Kovari et al., IBM, December 2002.
    - IBM WebSphere V4.0 Advanced Edition Security, by Peter Kovari et al., IBM, March 2002.
- Загальні
    - [Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html), OWASP
    - [SP 800-92](https://csrc.nist.gov/publications/detail/sp/800-92/final) Guide to Computer Security Log Management, NIST
    - [PCI DSS v3.2.1](https://www.pcisecuritystandards.org/document_library) Requirement 10 and PA-DSS v3.2 Requirement 4, PCI Security Standards Council
- Узагальнені:
    - [CERT Security Improvement Modules](https://resources.sei.cmu.edu/asset_files/SecurityImprovementModule/2000_006_001_13637.pdf): Securing Public Web Servers
    - [How To: Use IISLockdown.exe](https://support.microsoft.com/en-us/help/325864/how-to-install-and-use-the-iis-lockdown-wizard)
