# V5.1 Input Validation Requirements

Належним чином реалізовані засоби контролю валідації вхідних даних, що використовують позитивні списки дозволів та надійну типізацію даних, можуть усунути понад 90% всіх атак ін'єкцією. Перевірка довжини та діапазону може ще більше знизити цей показник. Вбудовування безпечної валідації вхідних даних необхідна під час розробки архітектури додатку, спринтів з проєктування, написання коду, а також модульного та інтеграційного тестування.

Хоча багато з цих елементів не можна знайти в тестах на проникнення, результати їх відсутності їх невиконання зазвичай можна знайти у V5.3 - Вимоги до кодування вихідних даних та запобігання ін'єкціям. Розробникам і рецензентам безпечного коду рекомендується ставитися до цього розділу так, ніби L1 потрібен для всіх елементів, щоб запобігти ін'єкціям.

| # | Опис | L1 | L2 | L3 | CWE |
| - | - | - | - | - | - |
| 5.1.1 | Переконайтеся, що додаток має захист від забруднення атак шляхом забруднення параметрів HTTP, особливо якщо фреймворк додатку не розрізняє джерело параметрів запиту (*GET, POST, файли cookie, заголовки або змінні оточення*). | ✓ | ✓ | ✓ | 235 |
| 5.1.2 | Переконайтеся, що фреймворки захищають від атак масового присвоєння параметрів, або що додаток має запобіжні заходи для захисту від небезпечного присвоєння параметрів, такі як позначення полів як приватні (*private*) або подібні. (C5) | ✓ | ✓ | ✓ | 915 |
| 5.1.3 | Переконайтеся, що всі вхідні дані (*поля HTML-форм, REST-запити, параметри URL, заголовки HTTP, файли cookie, пакетні (batch) файли, RSS-канали тощо*) перевіряються за допомогою позитивної валідації (*списки дозволених даних*). (C5) | ✓ | ✓ | ✓ | 20 |
| 5.1.4 | Переконайтеся, що структуровані дані надійно типізовані та перевірені за визначеною схемою, що включає дозволені символи, довжину та шаблон (*наприклад, номери кредитних карток, адреси електронної пошти, номери телефонів або перевірка відповідності двох пов'язаних полів, наприклад, перевірка відповідності передмістя та індексу/поштового індексу*). (C5) | ✓ | ✓ | ✓ | 20 |
| 5.1.5 | Переконайтеся, що перенаправлення та переадресація URL-адрес дозволяються лише на адреси, зазначені у списку дозволених, або показують попередження при перенаправленні на потенційно ненадійний вміст. | ✓ | ✓ | ✓ | 601 |

# C5: Перевірка дійсності всіх вхідних даних

Валідація вхідних даних - це метод програмування, який гарантує, що тільки правильно відформатовані дані можуть бути введені в компонент програмної системи.

## Синтаксична та семантична валідність

Додаток повинен перевіряти синтаксичну та семантичну валідність даних (саме в такому порядку), перш ніж використовувати їх у будь-який спосіб (включно з відображенням їх користувачеві).

**Синтаксична валідність** означає, що дані мають ту форму, яка очікується. Наприклад, програма може дозволити користувачеві вибрати чотиризначний "ідентифікатор облікового запису" для виконання певної операції. Додаток повинен вважати, що користувач вводить корисне навантаження для SQL-ін'єкції, і повинен перевірити, що дані, введені користувачем, мають довжину рівно чотири цифри і складаються лише з чисел (на додаток до використання правильної параметризації запиту).

**Семантична валідність** передбачає прийняття лише тих даних, які знаходяться в прийнятному діапазоні для даної функціональності та контексту програми. Наприклад, при виборі діапазонів дат дата початку повинна бути перед датою закінчення.

## Списки дозволу та заборони

Існує два загальних підходи до перевірки синтаксису вхідних даних, відомі як списки дозволу та заборони:

- **Забороняючий список** або **перевірка за забороняючим списком\*** намагається перевірити, що дані не містять "заздалегідь поганого" контенту. Наприклад, веб-додаток може блокувати введення, що містить точний текст `<SCRIPT>`, щоб запобігти XSS (*міжсайтовому скриптингу*). Однак цей захист можна обійти за допомогою тегу скрипта в нижньому регістрі або тегу скрипта в змішаному регістрі.
- **Список дозволів** або **перевірка за списком дозволів** намагається перевірити, чи відповідають дані набору "добре відомих" правил. Наприклад, правилом перевірки списку дозволених для штату США буде 2-літерний код, який є лише одним із дійсних штатів США.

**Важливо:** При створенні безпечного програмного забезпечення, список дозволів є рекомендованим мінімальним підходом. Список заборон схильний до помилок і може бути обійдений за допомогою різних методів ухилення, а також може бути небезпечним, коли покладається на нього сам по собі. Незважаючи на те, що список заборон часто можна обійти, він може бути корисним для виявлення очевидних атак. Таким чином, в той час як **списки дозволів** допомагають обмежити поверхню атаки, гарантуючи, що дані мають правильну синтаксичну і семантичну валідність, **список заборон** допомагає виявити і потенційно зупинити очевидні атаки.

## Перевірка на стороні клієнта і на стороні сервера

З міркувань безпеки валідація вхідних даних завжди повинна виконуватися на стороні сервера. Хоча перевірка на стороні клієнта може бути корисною як для функціональних, так і для деяких цілей безпеки, її часто можна легко обійти. Це робить перевірку на стороні сервера ще більш важливою для безпеки. Наприклад, валідація JavaScript може попередити користувача про те, що певне поле повинно складатися з чисел, але серверна програма повинна перевірити, що надіслані дані складаються лише з чисел у відповідному числовому діапазоні для цієї функції.

## Регулярні вирази

Регулярні вирази дозволяють перевірити, чи відповідають дані певному шаблону. Почнемо з простого прикладу.

Наступний регулярний вираз використовується для визначення правила списку дозволених для перевірки імен користувачів.

    ^[a-z0-9_]{3,16}$

Цей регулярний вираз дозволяє лише малі літери, цифри і символ підкреслення. Довжина імені користувача також обмежена 3 і 16 символами.

### Обережність: Потенційна можливість відмови в обслуговуванні

При створенні регулярних виразів слід дотримуватися обережності. Погано спроектовані вирази можуть призвести до потенційної відмови в обслуговуванні (так званої [ReDoS](https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS)). Перевірити, що регулярні вирази не є вразливими до ReDoS, можна за допомогою різних інструментів.

### Обережність: Складність

Регулярні вирази - це лише один із способів виконання перевірки. Регулярні вирази можуть бути складними в підтримці або розумінні для деяких розробників. Інші альтернативи валідації передбачають написання методів валідації програмно, що може бути легше підтримувати для деяких розробників.

## Обмеження валідації вхідних даних

**Перевірка даних не завжди робить дані "безпечними", оскільки певні форми складного введення можуть бути "валідними", але все одно небезпечними. Наприклад, валідна адреса електронної пошти може містити SQL-ін'єкцію або валідна URL-адреса може містити атаку міжсайтовим скриптингом**. До даних завжди слід застосовувати додаткові засоби захисту, окрім перевірки введення, такі як параметризація запитів або екранування.

## Проблеми валідації серіалізованих даних

Деякі форми введення настільки складні, що валідація може лише мінімально захистити додаток. Наприклад, небезпечно десеріалізувати ненадійні дані або дані, якими може маніпулювати зловмисник. Єдиний безпечний архітектурний шаблон - не приймати серіалізовані об'єкти з ненадійних джерел або виконувати десеріалізацію в обмеженому обсязі лише для простих типів даних. Вам слід уникати обробки серіалізованих форматів даних і використовувати простіші для захисту формати, такі як JSON, коли це можливо.

Якщо це неможливо, розгляньте ряд засобів захисту при обробці серіалізованих даних.

- Впроваджуйте перевірки цілісності або шифрування серіалізованих об'єктів, щоб запобігти створенню ворожих об'єктів або фальсифікації даних.
- Застосовуйте суворі обмеження типів під час десеріалізації перед створенням об'єктів; зазвичай код очікує на визначений набір класів. Було продемонстровано обхідні шляхи для цієї техніки.
- Ізолюйте код, який десеріалізується, таким чином, щоб він виконувався у середовищах з дуже низькими рівнями дозволів, наприклад, у тимчасових контейнерах.
- Журналізуйте винятки та збої десеріалізації з точки зору безпеки, наприклад, коли вхідний тип не відповідає очікуваному, або коли десеріалізація генерує винятки.
- Обмеження або моніторинг вхідного та вихідного мережевого з'єднання з контейнерів або серверів, які десеріалізуються.
- Відстежуйте десеріалізацію, сповіщаючи, якщо користувач постійно виконує десеріалізацію.

## Неочікуване введення даних користувачем (Масове призначення)

Деякі фреймворки підтримують автоматичне прив'язування параметрів HTTP-запитів до об'єктів на стороні сервера, що використовуються програмою. Ця функція автоматичного прив'язування може дозволити зловмиснику оновити об'єкти на стороні сервера, які не були призначені для модифікації. За допомогою цієї функції зловмисник може змінити рівень контролю доступу або обійти заплановану бізнес-логіку додатку.

Ця атака має декілька назв, серед яких: масове призначення, автоприв'язка та ін'єкція об'єктів.

Як простий приклад, якщо об'єкт користувача має поле privilege, яке визначає рівень привілеїв користувача в додатку, зловмисник може шукати сторінки, на яких змінюються дані користувача, і додавати privilege=admin до HTTP-параметрів, що надсилаються. Якщо автоприв'язка увімкнена небезпечним способом, об'єкт на стороні сервера, що представляє користувача, буде змінено відповідним чином.

Для вирішення цієї проблеми можна використовувати два підходи:

- Уникайте прив'язки вводу безпосередньо і використовуйте замість цього об'єкти передачі даних (DTO).
- Увімкніть автоматичне прив'язування, але налаштуйте правила списку дозволів для кожної сторінки або функції, щоб визначити, які поля дозволено автоматично прив'язувати.

Більше прикладів можна знайти у [Шпаргалці з масового призначення OWASP.](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)

## Перевірка та очищення HTML

Розглянемо програму, яка повинна приймати HTML від користувачів (за допомогою редактора WYSIWYG, який представляє вміст у вигляді HTML, або функцій, які безпосередньо приймають HTML на вході). У цій ситуації валідація або екранування не допоможуть.

- Регулярні вирази недостатньо виразні, щоб зрозуміти складність HTML5.
- Шифрування або екранування HTML не допоможе, оскільки це призведе до неправильного відображення HTML.

Тому вам потрібна бібліотека, яка може розбирати і очищати текст у форматі HTML. Будь ласка, зверніться до шпаргалки по запобіганню XSS на тему "Санація HTML" для отримання додаткової інформації про санітарну обробку HTML.

## Функціонал валідації в бібліотеках і фреймворках

Усі мови та більшість фреймворків надають бібліотеки або функції валідації, які слід використовувати для перевірки даних. Бібліотеки валідації зазвичай охоплюють поширені типи даних, вимоги до довжини, цілочисельні діапазони, перевірку на "є нулем" тощо. Багато бібліотек і фреймворків валідації дозволяють вам визначати власні регулярні вирази або логіку для кастомної валідації таким чином, щоб програміст міг використовувати цю функціональність у своєму додатку. Прикладами функціональності перевірки є функції фільтрів PHP або Hibernate Validator для Java. Приклади санітайзерів HTML включають метод санітарної обробки Ruby on Rails, OWASP Java HTML Sanitizer або DOMPurify.

# CWE-235: Неналежна обробка додаткових параметрів

## Опис

Продукт не обробляє або неправильно обробляє випадок, коли кількість однойменних параметрів, полів або аргументів перевищує очікувану кількість.

## Застосовується до платформ

### Мови

- Клас: Неспецифічний для мови (*невизначена поширеність*)

## Наслідки

| Область впливу | Сила впливу | Ймовірність |
| - | - | - |
| Цілісність | Технічний вплив: Неочікуваний стан | - |

# CWE-915: Неналежний контроль над модифікацією динамічно-визначениї атрибутів об'єктів

## Опис

Продукт отримує вхідні дані від попереднього компонента, який визначає декілька атрибутів, властивостей або полів, що мають бути ініціалізовані або оновлені в об'єкті, але він не контролює належним чином, які саме атрибути можна змінювати.

## Розширений опис

Якщо об'єкт містить атрибути, призначені лише для внутрішнього використання, то їх несподівана модифікація може призвести до вразливості.

Ця вразливість іноді відома завдяки специфічним механізмам мови, які роблять її можливою, таким як масове присвоювання, автоприв'язування або ін'єкція об'єктів.

## Застосовується до платформ

### Мови

- Ruby (*невизначена поширеність*)
- ASP.NET (*невизначена поширеність*)
- PHP (*невизначена поширеність*)
- Python (*невизначена поширеність*)
- Клас: Неспецифічний для мови (*невизначена поширеність*)

## Наслідки

| Область впливу | Сила впливу | Ймовірність |
| - | - | - |
| Цілісність | Технічний вплив: зміна даних застосунку - зловмисник може змінити чутливі дані або змінні програми | - |
| Цілісність | Технічний вплив: виконання недозволеного коду або команд | - |
| Інша Цілісність | Технічний вплив: залежить від контексту; Зміна логіки виконання | - |

# CWE-20: Неналежна валідація вхідних даних

## Опис

Продукт отримує вхідні дані, але не перевіряє або неправильно перевіряє, що вхідні дані мають властивості, необхідні для безпечної та правильної обробки даних.

## Розширений опис

Валідація вхідних даних - це часто використовуваний метод перевірки потенційно небезпечних вхідних даних, щоб переконатися, що вони безпечні для обробки в коді або при взаємодії з іншими компонентами. Якщо програмне забезпечення не перевіряє вхідні дані належним чином, зловмисник може створити вхідні дані у формі, яка не очікується рештою програми. Це призведе до того, що деякі частини системи отримають непередбачувані дані, що може призвести до зміни потоку управління, довільного контролю над ресурсом або довільного виконання коду.

Однак перевірка вхідних даних - не єдиний метод обробки вхідних даних. Інші методи намагаються перетворити потенційно небезпечні вхідні дані на щось безпечне, наприклад, фільтрація (CWE-790), яка намагається видалити небезпечні вхідні дані, або кодування/екранування (CWE-116), яке намагається гарантувати, що вхідні дані не будуть неправильно інтерпретовані, коли вони будуть включені у вихідні дані іншого компонента. Існують також інші методи (див. CWE-138 для отримання додаткових прикладів).

Перевірка вхідних даних може бути застосована до:

- вихідних даних - рядків, чисел, параметрів, вмісту файлів тощо
- метаданих - інформації про вихідні дані, наприклад, заголовків або розміру

Дані можуть бути простими або структурованими. Структуровані дані можуть складатися з багатьох вкладених шарів, що складаються з комбінацій метаданих і необроблених даних з іншими простими або структурованими даними.

Багато властивостей необроблених даних або метаданих можуть потребувати перевірки при введенні в код, наприклад

- вказані величини, такі як розмір, довжина, частота, ціна, швидкість, кількість операцій, час тощо
- неявні або похідні величини, такі як фактичний розмір файлу замість вказаного розміру
- індекси, зміщення або позиції в більш складні структури даних
- символьні ключі або інші елементи у хеш-таблиці, асоціативні масиви тощо
- правильність оформлення, тобто синтаксична коректність - відповідність очікуваному синтаксису
- лексична коректність токенів - відповідність правилам для того, що розглядається як токен
- вказаний або похідний тип - фактичний тип вхідних даних (або те, чим вхідні дані виглядають)
- узгодженість - між окремими елементами даних, між первинними даними та метаданими, між посиланнями тощо
- відповідність специфічним для домену правилам, наприклад, бізнес-логіці
- еквівалентність - забезпечення однакового ставлення до еквівалентних вхідних даних
- автентичність, право власності або інші засвідчення про вхідні дані, наприклад, криптографічний підпис для підтвердження джерела даних 

Неявні або похідні властивості даних часто доводиться обчислювати або виводити з самого коду. Помилки у виведенні властивостей можна вважати фактором, що сприяє неналежній перевірці вхідних даних.

Зверніть увагу, що "перевірка вхідних даних" має дуже різні значення для різних людей або в рамках різних схем класифікації. Необхідно бути обережним, посилаючись на цей елемент CWE або мапуючи на нього. Наприклад, деякі вразливості можуть бути пов'язані з ненавмисним наданням зловмиснику контролю над вхідними даними, коли він взагалі не повинен мати можливості надавати вхідні дані, але іноді це називається перевіркою вхідних даних.

Нарешті, важливо підкреслити, що відмінності між перевіркою вводу та екрануванням виводу часто розмиті, і розробники повинні бути уважними, щоб зрозуміти різницю, в тому числі те, що перевірка вводу не завжди є достатньою для запобігання уразливостям, особливо коли потрібно підтримувати менш суворі типи даних, такі як текст у довільній формі. Розглянемо сценарій SQL-ін'єкції, в якому в запит вставляється прізвище людини. Прізвище "O'Reilly", швидше за все, пройде етап перевірки, оскільки воно є поширеним прізвищем в англійській мові. Однак, це правильне прізвище не можна безпосередньо вставити в базу даних, оскільки воно містить символ апострофа "'", який потрібно буде екранувати або перетворити іншим чином. У цьому випадку видалення апострофа може зменшити ризик SQL-ін'єкції, але це призведе до некоректної поведінки, оскільки буде записано неправильне ім'я.

## Застосовується до платформ

### Мови

- Клас: Неспецифічний для мови (*невизначена поширеність*)

## Наслідки

| Область впливу | Сила впливу | Ймовірність |
| - | - | - |
| Доступність | Технічний вплив: DoS: Відмова, вихід або перезапуск; DoS: Споживання ресурсів (CPU); DoS: Споживання ресурсів (пам'ять) - Зловмисник може передати неочікувані значення та спричинити аварійне завершення роботи програми або надмірне споживання ресурсів, таких як пам'ять та процесор. | - |
| Конфіденційність | Технічний вплив: Читання пам'яті; читання файлів або каталогів - Зловмисник може прочитати конфіденційні дані, якщо він може контролювати посилання на ресурси. | - |
| Цілісність, Конфіденційність, Доступність | Технічний вплив: Модифікація пам'яті; виконання несанкціонованого коду або команд - Зловмисник може використати зловмисний ввід для модифікації даних або, можливо, змінити потік керування у неочікуваний спосіб, включаючи довільне виконання команд. | - |

## Ймовірність використання вразливості

Висока

# CWE-601: Перенаправлення URL до ненадійного сайту ('відкрите перенаправлення')

## Опис

Веб-додаток приймає контрольований користувачем ввід, який вказує посилання на зовнішній сайт, і використовує це посилання для перенаправлення.Це спрощує фішингові атаки.

## Розширений опис

Параметр http може містити значення URL-адреси і може змусити веб-додаток перенаправляти запит на вказану URL-адресу.Змінивши значення URL-адреси на шкідливий сайт, зловмисник може успішно запустити фішингову аферу і викрасти облікові дані користувача. Оскільки ім'я сервера в зміненому посиланні ідентичне оригінальному сайту, фішингові спроби виглядають більш достовірними. Чи є ця проблема вразливістю, залежить від цільової поведінки програми. Наприклад, пошукова система може навмисно перенаправляти на довільні URL-адреси.

## Застосовується до платформ

### Мови

- Клас: Неспецифічний для мови (*невизначена поширеність*)

### Технології

- Клас: На основі Web (*невизначена поширеність*)

## Наслідки

| Область впливу | Сила впливу | Ймовірність |
| - | - | - |
| Контроль доступу | Технічний вплив: Обхід механізму захисту; отримання привілеїв або привласнення особистості  - Користувач може бути перенаправлено на ненадійну сторінку, яка містить шкідливе програмне забезпечення, що може скомпрометувати комп'ютер користувача. Це наражає користувача на значний ризик, а взаємодія користувача з веб-сервером також може бути скомпрометована, якщо шкідливе програмне забезпечення здійснює клавіатурне шпигунство або інші атаки з метою викрадення облікових даних, персональної інформації (PII) або інших важливих даних. | - |
| Контроль доступу, конфіденційність, інше | Технічний вплив: Обхід механізму захисту; отримання привілеїв або присвоєння особистих даних; інше - Користувач може зазнати фішингової атаки через перенаправлення на ненадійну сторінку. Фішингова атака може вказувати на контрольовану зловмисником веб-сторінку, яка видається надійним веб-сайтом. Потім фішери можуть викрасти облікові дані користувача, а потім використати їх для доступу до легітимного веб-сайту. | - |

## Ймовірність використання вразливості

Низька
